# Notes:
#   - Minimal appveyor.yml file is an empty file. All sections are optional.
#   - Indent each level of configuration with 2 spaces. Do not use tabs!
#   - All section names are case-sensitive.
#   - Section names should be unique on each level.

---
# ---------------------------------#
#       general configuration      #
# ---------------------------------#

# version format
version: 0.{build}

# branches to build
branches:
  # blacklist
  except:
    - gh-pages

# Do not build on tags (GitHub only)
skip_tags: true

# ---------------------------------#
#    environment configuration    #
# ---------------------------------#

# Operating system (build VM template)
os: Windows Server 2012

# clone directory
clone_folder: c:\projects\hdlcc

# fetch repository as zip archive
shallow_clone: false

# set clone depth
clone_depth: 5

# environment variables
environment:
  CACHE_PATH: "%LOCALAPPDATA%\\cache"
  HDLCC_CI: "%LOCALAPPDATA%\\hdlcc_ci"
  matrix:
    - BUILDER_NAME: ghdl
      INSTALL_DIR: "%LOCALAPPDATA%\\ghdl-0.31-mcode-win32"
      arch: 32
      URL: http://pilotfiber.dl.sourceforge.net/project/ghdl-updates/Builds/ghdl-0.31/Windows/ghdl-0.31-mcode-win32.zip
      # URL: http://pilotfiber.dl.sourceforge.net/project/ghdl-updates/Builds/ghdl-0.33/ghdl-0.33-win32.zip"
    - BUILDER_NAME: msim
      BUILDER_PATH: "%LOCALAPPDATA%\\modelsim_ase\\win32aloem"
      arch: 32
      URL: http://download.altera.com/akdlm/software/acdsinst/15.1/185/ib_installers/ModelSimSetup-15.1.0.185-windows.exe


# # build cache to preserve files/folders between builds
# cache:
#   - '%CACHE_PATH%'

# scripts that run after cloning repository
install:
  - echo "Starting path is %CD%"
  - "git submodule update --init --recursive"
  - echo "HDLCC_CI=%HDLCC_CI%"
  - "git clone https://github.com/suoto/hdlcc_ci %HDLCC_CI% --recursive"

  - ps: $env:python = if ($env:arch -eq 32) { 'C:\Python27' } else
                                            { 'C:\Python27-x64' }

  - echo "Python selected is %python%"
  # - appveyor DownloadFile https://bootstrap.pypa.io/get-pip.py
  - set PATH=%python%;%python%\Scripts;%PATH%
  # - python get-pip.py
  - pip install -r requirements.txt
  - pip install git+https://github.com/suoto/rainbow_logging_handler
  - if not exist "%CACHE_PATH%" mkdir "%CACHE_PATH%"
  - echo "Configured builder is %BUILDER_NAME%"

  - ps: if ($env:BUILDER_NAME -eq "msim")
      {. "$env:APPVEYOR_BUILD_FOLDER\\.ci\\scripts\\setup_msim.ps1"}

  - ps: if ($env:BUILDER_NAME -eq "ghdl")
      {. "$env:APPVEYOR_BUILD_FOLDER\\.ci\\scripts\\setup_ghdl.ps1"}

  - if "%BUILDER_NAME%" == "msim"
      %BUILDER_PATH%\\vcom -version

  - "pip install -U -e %APPVEYOR_BUILD_FOLDER%"

  - "python %APPVEYOR_BUILD_FOLDER%\\.ci\\scripts\\run_tests.py
      -vv -F -B --log-capture %EXTRA_ARGS%"

  - coverage combine
  - coverage report
  - codecov
  - dir /B "%HOMEPATH%\\*.log"
  - 7z a hdlcc_success.zip "%HOMEPATH%\\*.log" "*.log"
  - appveyor PushArtifact hdlcc_success.zip

# We won't build or run tests from here
build: off
test: off

on_failure:
  - 7z a hdlcc_failure.zip "%HOMEPATH%\\*.log" "*.log"
  - appveyor PushArtifact hdlcc_failure.zip

# artifacts:
#   - path: "%HOMEPATH%\\*.log"
#     name: Logs
