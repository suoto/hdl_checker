[tox]
envlist = {py27,py37}-{msim,ghdl,xvhdl,others}-{linux,windows}

[testenv]
platform =
    linux: linux
    windows: win32|win64

passenv =
  GIT_URL
  GHDL_PATH
  MODELSIM_PATH
  XSIM_PATH

setenv =
  GIT_URL = {env:GIT_URL:https://github.com/suoto}
  GHDL_PATH = {env:GHDL_PATH:{env:HOME}/builders/ghdl/bin/}
  MODELSIM_PATH = {env:MODELSIM_PATH:{env:HOME}/builders/msim/modelsim_ase/linux/}
  XSIM_PATH = {env:XSIM_PATH:{env:HOME}/builders/xvhdl/bin/}

  CI_TEST_SUPPORT_PATH = ./.ci/test_support/ 

  !dbg: DEBUG =
  dbg: DEBUG = --log-to-stdout --fail-fast

# install pytest in the virtualenv where commands will be executed
deps =
    coverage==4.1
    mock==2.0.0
    nose2-cov==1.0a4
    nose2==0.6.5
    parameterized==0.7.0
    six==1.10.0
    testfixtures==4.10.0
    vunit-hdl==0.66.0
    unittest2==1.1.0
    WebTest==2.0.23

    git+https://github.com/suoto/rainbow_logging_handler

# NOTE: you can run any command line tool here - not just tests
whitelist_externals =
  linux: bash
  linux-!local: cp

  windows-!local: Xcopy

  !local: git

  local: tox

commands_pre:

  linux-{msim,ghdl,xvhdl,local}: git clone --depth 1 --quiet {env:GIT_URL}/grlib "{envtmpdir}/grlib"
  # To remove git sutff so git clean -fdx can clean that
  linux: bash -c 'rm -rf $(find {envtmpdir} -iname "\.git")'

  windows-{msim,ghdl,xvhdl}: git clone --depth 1 {env:GIT_URL}/grlib "{envtmpdir}\\grlib"

commands =
  msim:   python .ci/scripts/run_tests.py -v  {env:DEBUG} --log-level DEBUG --msim
  ghdl:   python .ci/scripts/run_tests.py -v  {env:DEBUG} --log-level DEBUG --ghdl
  others: python .ci/scripts/run_tests.py -v  {env:DEBUG} --log-level DEBUG --others
  xvhdl:  python .ci/scripts/run_tests.py -v  {env:DEBUG} --log-level DEBUG --xvhdl

  coverage combine
  coverage html
